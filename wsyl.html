<!DOCTYPE html>
<html>
<head>
	<script src="papaparse.min.js" type="text/javascript"></script>
	<script src="math.js" type="text/javascript"></script>
	<style>
		td {
			text-align: center;
		}
		.numinputcell {
			width: 90%;
		}
	</style>
</head>
<body>
	<p>This is a tool for determining where you should live based on your climate preferences. To use it, simply input your ideal temperatures and humidity levels for each month. If you're not sure what humidity levels you prefer, you can use one of the presets from the drop-down menu. You can also click the "More info" button to see what the presets are like, as well as what different humidity values correspond to in this tool.</p>
	<form>
		<table style="width:60%">
			<tr>
				<th align="left">Month</th>
				<td>Jan</td>
				<td>Feb</td>
				<td>Mar</td>
				<td>Apr</td>
				<td>May</td>
				<td>Jun</td>
				<td>Jul</td>
				<td>Aug</td>
				<td>Sep</td>
				<td>Oct</td>
				<td>Nov</td>
				<td>Dec</td>
			</tr>
			<tr>
				<th align="left">Temperature</th>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="-459" max="212" step="0.1"></td>
			</tr>
			<tr>
				<th align="left">%Humidity</th>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
				<td><input type="number" class="numinputcell" min="0" max="100" step="0.1"></td>
			</tr>
		</table>
		<p><div>Which degree scale are your temperatures in?<br>
			<input type="radio" id="degreebuttonf" name="degreescale" value="fahrenheit" checked>
			<label for="degreebuttonf">Fahrenheit</label>
			<input type="radio" id="degreebuttonc" name="degreescale" value="celsius">
			<label for="degreebuttonc">Celsius</label>
		</div></p>
		<p><div>Which hemisphere are you in?<br>
			<input type="radio" id="hemispherebutton_n" name="whichhemisphere" value="nhemis" checked>
			<label for="hemispherebutton_n">Northern hemisphere (January is in the winter)</label><br>
			<input type="radio" id="hemispherebutton_s" name="whichhemisphere" value="shemis">
			<label for="hemispherebutton_s">Southern hemisphere (January is in the summer)</label>
		</div></p>
		<p>Unsure about humidity? You can select from this list of presets: <select id="humiditypresets">
			<option value="own" selected>(I'm using my own humidity values)</option>
			<option value="yazd">Desert</option>
			<option value="dubai">Arid</option>
			<option value="mongolia">Dry steppe</option>
			<option value="ukraine">Moderate steppe</option>
			<option value="med">Mediterranean</option>
			<option value="monsoon">Monsoon once per year</option>
			<option value="invertedsteppe">Dry winter, humid summer</option>
			<option value="colwood">Vancouver Island</option>
			<option value="oceanic">Wet year-round (Oceanic climate)</option>
			<option value="rainforest">Tropical rainforest</option>
		</select> <input type="button" value="Select preset"> <input type="button" value="More info"></p>
		<div id="presethelp" style="display:none">
			<p>In this tool, monthly humidity is calculated by comparing a city's average dew point to its average temperature. The result of this approximates humidity in the morning; humidity is ordinarily lower than this in the afternoon (by up to 30 points!) and higher at night. A monthly average below 40 on this scale is typical of a desert, the 40s and 50s are dry, the 60s are moderate, the 70s are fairly humid, and anything above 80 is considered very humid.</p>
			<p>The <b>desert</b> preset is very dry all year round, the kind of climate one might find in Las Vegas or Baghdad.</p>
			<p>The <b>arid</b> preset represents a desert or otherwise dry climate where there is some moisture in the air, often due to being adjacent to an ocean.</p>
			<p>The <b>dry steppe</b> preset features snowy or rainy winters and dry, dusty summers. This climate is common in places like Mongolia and Kazakhstan.</p>
			<p>The <b>moderate steppe</b> preset is similar to the dry steppe one, but slightly wetter in the summer. The North American plains have a climate like this.</p>
			<p>The <b>Mediterranean</b> preset represents the weather conditions common around the Mediterranean Sea: dry in the summer and moderate in the winter.</p>
			<p>The <b>monsoon</b> preset has a dry spring, wet summer and moderate winter, so that humidity is relatively uncorrelated with temperature.</p>
			<p>The <b>dry winter, humid summer</b> preset is exactly what it sounds like. This climate is common in the southeastern United States and southern China.</p>
			<p><b>Vancouver Island</b>, at least the eastern side of it, is very rainy and foggy in the winter and has Mediterranean or steppe-like conditions in the summer.</p>
			<p>The <b>oceanic</b> preset is rainy all year, but especially so in the winter, and typically mild as a result. Great Britain is a good example of this kind of climate.</p>
			<p>The <b>tropical rainforest</b> preset is also wet all year. Unlike an oceanic climate, a tropical rainforest has little variation in humidity throughout the year.</p>
		</div>
		<p>Optional: You can filter your results geographically. Which region of the world do you want to see results from? <select id="regionselector">
			<option value="everywhere">Entire world</option>
			<option value="cee">Central/Eastern Europe and Russia</option>
			<option value="mena">Middle East, Central Asia and North Africa</option>
			<option value="subcon">South and Southeast Asia</option>
			<option value="eastasia">East Asia</option>
			<option value="oznz">Australia, New Zealand and the Pacific</option>
			<option value="america">The United States and Canada</option>
			<option value="latin">Latin America and the Caribbean</option>
			<option value="westerneurope">Western Europe</option>
			<option value="africa">Sub-Saharan Africa</option>
		</select></p>
		<div>
			<input type="checkbox" id="latlongcheck"> Also restrict my results to places close to a given location: 
			<input type="number" min="0" max="90" id="latbox">
			<select id="lathemselector">
				<option value="nhem">N</option>
				<option value="shem">S</option>
			</select>, 
			<input type="number" min="0" max="90" id="longbox">
			<select id="longhemselector">
				<option value="ehem">E</option>
				<option value="whem">W</option>
			</select>
		</div>
		<p><input type="button" value="Where should you live?"></p>
		<p id="weatherResult"></p>
		<p id="dump"></p>
	</form>
	<script type="text/javascript">
		var presetSelectButton = document.querySelectorAll('input[type="button"]')[0];
		var infoButton = document.querySelectorAll('input[type="button"]')[1];
		var weatherTestButton = document.querySelectorAll('input[type="button"]')[2];

		var rot = 0;

		var presetArray = math.matrix(
			[[45.6,39.4,29.8,24.4,21.4,19.0,20.4,22.6,24.8,28.2,38.0,47.2],
			 [63.4,58.6,52.0,46.2,43.0,44.0,45.0,49.0,54.2,55.8,60.6,65.0],
			 [82.4,78.8,70.0,58.0,54.2,50.6,48.8,51.0,55.8,66.6,78.0,83.2],
			 [83.6,79.8,73.4,65.2,64.0,63.8,62.0,60.4,66.6,73.2,81.0,84.6],
			 [72.4,69.0,63.4,59.2,55.4,50.8,47.0,48.8,55.6,62.6,70.8,72.6],
			 [59.4,54.8,50.0,47.2,51.6,63.6,76.2,78.0,74.2,66.2,63.0,61.6],
			 [66.6,67.6,69.2,71.8,75.6,77.0,75.6,75.8,74.4,70.4,67.6,66.6],
			 [90.0,84.7,80.2,73.3,69.5,68.3,65.2,67.3,73.5,83.7,88.5,90.2],
			 [86.0,84.0,81.6,79.6,78.8,79.2,80.4,81.6,82.6,84.4,85.8,86.8],
			 [82.8,82.4,81.4,81.4,82.8,84.0,84.8,86.0,85.6,85.2,84.2,83.0]]); // Humidity presets (columns are months)

		presetSelectButton.onclick = function() {

			if (document.getElementById("hemispherebutton_s").checked === true) {
				rot = 6; // Southern hemisphere weather data is rotated by 6 months
			}
			else {
				rot = 0;
			}

			if (document.getElementById("humiditypresets").selectedIndex > 0) {
				var selectedPreset = document.getElementById("humiditypresets").selectedIndex - 1;
				for (k = 0; k < 12; k++) {
					document.querySelectorAll('input[type="number"]')[math.mod((k + rot),12) + 12].value = presetArray.subset(math.index(selectedPreset,k))
				}
			}
		}

		infoButton.onclick = function() {
			if (infoButton.value === "More info") {
				document.getElementById("presethelp").style.display = "block";
				infoButton.value = "Less info";
			}
			else {
				document.getElementById("presethelp").style.display = "none";
				infoButton.value = "More info";
			}
		}

		weatherTestButton.onclick = function() {

			var farTempInputs = new Array(12);
			var celTempInputs = new Array(12);
			var tempInputs = new Array(12);

			var humidInputs = new Array(12);

			var hemisphereLatInput = null;

			for (i = 0; i < tempInputs.length; i++) {
				farTempInputs[i] = parseFloat(document.querySelectorAll('input[type="number"]')[i].value);
				celTempInputs[i] = ((parseFloat(document.querySelectorAll('input[type="number"]')[i].value) * (9 / 5)) + 32)
				// My parsed data in the spreadsheet is in Fahrenheit, so I convert everything to Fahrenheit for calculations
				humidInputs[i] = parseFloat(document.querySelectorAll('input[type="number"]')[i+12].value);
			}

			if (document.getElementById("degreebuttonc").checked === true) {
				tempInputs = celTempInputs;
			}
			else {
				tempInputs = farTempInputs;
			}

			if (document.getElementById("hemispherebutton_s").checked === true) {
				hemisphereLatInput = "S";
			}
			else {
				hemisphereLatInput = "N";
			}

			if (document.getElementById("latlongcheck").checked === true) {
				var latInput = document.getElementById("latbox").value;
				var longInput = document.getElementById("longbox").value;
				var maxPhysicalDistance = 200000; // In metres, for haversine formula
				if (document.getElementById("lathemselector").selectedIndex === 1) {
					latInput = latInput*(-1); // Southern hemisphere is negative on the latitude axis
				}
				if (document.getElementById("longhemselector").selectedIndex === 1) {
					longInput = longInput*(-1);
				}
				console.log(latInput);
				console.log(longInput);
			}
			else {
				var latInput = 0; var longInput = 0; var maxPhysicalDistance = 999999999999;
				console.log("Button is not checked");
			}

			Papa.parse("weather_noprecip_full.csv", {
				header: true,
				dynamicTyping: true,
				download: true,
				delimiter: ",",
				complete: function(results) {
					var stations = results.data;
					var closest_station = null;

					var stationTemps = new Array(12);
					var comparisonTempArray = new Array(12);
					var stationHumids = new Array(12);
					var comparisonHumidArray = new Array(12);

					var tempNorm_overallBest = 9999999999;
					var tempNorm_current = tempNorm_overallBest
					var humidNorm_overallBest = tempNorm_overallBest;
					var humidNorm_current = tempNorm_overallBest;
					var overallNorm_overallBest = tempNorm_overallBest;

					var stationLatHemisphere = null;
					var stationLongHemisphere = null;
					var stationRegion = null;
					var stationLat = null;
					var stationLong = null;

					var inputRegion = document.getElementById("regionselector").selectedIndex;

					// Haversine formula
					var radius = 6371e3; // Earth's radius
					var phiOrigin = latInput*(Math.PI / 180);
					console.log(phiOrigin);

					for (i = 0; i < stations.length; i++) {
						// Going station by station, extracting data, and comparing against the current best station
						stationLatHemisphere = stations[i].lat_hemisphere;
						stationRegion = stations[i].region;
						stationLat = (stations[i].lat_degrees + (stations[i].lat_minutes / 60))*Math.PI/180;
						stationLong = (stations[i].long_degrees + (stations[i].long_minutes / 60))*Math.PI/180;
						if (stationLatHemisphere === "S") {
							stationLat = stationLat*(-1);
						}
						if (stationLongHemisphere === "W") {
							stationLong = stationLong*(-1);
						}

						// Haversine formula, continued
						var phiStation = stationLat*(Math.PI / 180);
						var phiDiff = (stationLat - latInput)*(Math.PI / 180);
						var lambdaDiff = (stationLong - longInput)*(Math.PI / 180);
						var interStep = (Math.sin(phiDiff/2)*Math.sin(phiDiff/2)) + (Math.cos(phiOrigin)*Math.cos(phiStation)*Math.sin(lambdaDiff/2)*Math.sin(lambdaDiff/2));
						var distanceStationToOrigin = 2*radius*Math.atan2(Math.sqrt(interStep),Math.sqrt(1 - interStep));

						if (stationLatHemisphere === hemisphereLatInput) {
							stationTemps[0] = stations[i].jan_temp;
							stationTemps[1] = stations[i].feb_temp;
							stationTemps[2] = stations[i].mar_temp;
							stationTemps[3] = stations[i].apr_temp;
							stationTemps[4] = stations[i].may_temp;
							stationTemps[5] = stations[i].jun_temp;
							stationTemps[6] = stations[i].jul_temp;
							stationTemps[7] = stations[i].aug_temp;
							stationTemps[8] = stations[i].sep_temp;
							stationTemps[9] = stations[i].oct_temp;
							stationTemps[10] = stations[i].nov_temp;
							stationTemps[11] = stations[i].dec_temp;

							stationHumids[0] = stations[i].jan_humid;
							stationHumids[1] = stations[i].feb_humid;
							stationHumids[2] = stations[i].mar_humid;
							stationHumids[3] = stations[i].apr_humid;
							stationHumids[4] = stations[i].may_humid;
							stationHumids[5] = stations[i].jun_humid;
							stationHumids[6] = stations[i].jul_humid;
							stationHumids[7] = stations[i].aug_humid;
							stationHumids[8] = stations[i].sep_humid;
							stationHumids[9] = stations[i].oct_humid;
							stationHumids[10] = stations[i].nov_humid;
							stationHumids[11] = stations[i].dec_humid;
						}
						else {
							// If the station is in a different hemisphere from the input data, everything needs to be rotated by 6 months
							stationTemps[0] = stations[i].jul_temp;
							stationTemps[1] = stations[i].aug_temp;
							stationTemps[2] = stations[i].sep_temp;
							stationTemps[3] = stations[i].oct_temp;
							stationTemps[4] = stations[i].nov_temp;
							stationTemps[5] = stations[i].dec_temp;
							stationTemps[6] = stations[i].jan_temp;
							stationTemps[7] = stations[i].feb_temp;
							stationTemps[8] = stations[i].mar_temp;
							stationTemps[9] = stations[i].apr_temp;
							stationTemps[10] = stations[i].may_temp;
							stationTemps[11] = stations[i].jun_temp;

							stationHumids[0] = stations[i].jul_humid;
							stationHumids[1] = stations[i].aug_humid;
							stationHumids[2] = stations[i].sep_humid;
							stationHumids[3] = stations[i].oct_humid;
							stationHumids[4] = stations[i].nov_humid;
							stationHumids[5] = stations[i].dec_humid;
							stationHumids[6] = stations[i].jan_humid;
							stationHumids[7] = stations[i].feb_humid;
							stationHumids[8] = stations[i].mar_humid;
							stationHumids[9] = stations[i].apr_humid;
							stationHumids[10] = stations[i].may_humid;
							stationHumids[11] = stations[i].jun_humid;
						}

						if (inputRegion == stationRegion || inputRegion == 0) {

							if (distanceStationToOrigin < maxPhysicalDistance) {

								for (j = 0; j < stationTemps.length; j++) {
									comparisonTempArray[j] = tempInputs[j] - stationTemps[j]; // Building an array of differences (month by month)
									comparisonHumidArray[j] = humidInputs[j] - stationHumids[j];
								}

								tempNorm_current = math.norm(comparisonTempArray); // 2-norm (least squares)
								humidNorm_current = math.norm(comparisonHumidArray);
								var comparisonOverallArray = [tempNorm_current, humidNorm_current];

								if (math.norm(comparisonOverallArray) < overallNorm_overallBest) {
									overallNorm_overallBest = math.norm(comparisonOverallArray);
									tempNorm_overallBest = tempNorm_current;
									humidNorm_overallBest = humidNorm_current;
									closest_station = stations[i].city_nominal.concat(", ",stations[i].country," (difference scores ",math.round(tempNorm_overallBest,3)," temperature, ",math.round(humidNorm_overallBest,3)," humidity)");
								}
							}
						}
					}

					if (closest_station === null) {
						closest_station = "Make sure you fill in all of the input boxes."
					}

					document.getElementById("weatherResult").innerHTML = closest_station;
				}
			})
		}
	</script>
</body>
</html>
